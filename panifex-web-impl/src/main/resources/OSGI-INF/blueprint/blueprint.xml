<?xml version="1.0" encoding="UTF-8"?>
<!--
  Panifex platform
  Copyright (C) 2013  Mario Krizmanic
  
  This library is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public
  License as published by the Free Software Foundation; either
  version 2.1 of the License, or any later version.
  
  This library is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  Lesser General Public License for more details.
  
  You should have received a copy of the GNU Lesser General Public
  License along with this library; if not, write to the Free Software
  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
-->
<blueprint 
    xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.osgi.org/xmlns/blueprint/v1.0.0
            http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">
    
    <!-- App Menu -->
    
    <service ref="appMenuService">
        <interfaces>
            <value>org.panifex.module.api.menu.AppMenuService</value>
        </interfaces>
        <registration-listener 
            ref="appMenuServiceHolder"
            registration-method="registerAppMenuService"
            unregistration-method="unregisterAppMenuService"/>
    </service>
    
    <bean id="appMenuService"
        class="org.panifex.web.impl.menu.AppMenuServiceImpl"/>
    
    <bean id="appMenuServiceHolder"
        class="org.panifex.web.impl.menu.AppMenuServiceHolder"></bean>
    
    <!-- Content Manager -->
    
    <reference-list interface="org.panifex.module.api.content.Content"
            availability="optional">
        <reference-listener ref="contentManager"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference-list>
    
    <bean id="contentManager"
            class="org.panifex.web.impl.content.ContentManager">
        <property name="contentUiFactory" ref="contentUiFactory"/>
    </bean>
    
    <!-- Content UI Factory -->
    
    <bean id="contentUiFactory"
        class="org.panifex.web.impl.content.ContentUiFactory"/>
    
    <!-- Label Locator -->
    
    <reference-list interface="org.panifex.module.api.i18n.LocaleService"
            availability="optional">
        <reference-listener ref="localeServiceListener"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference-list>
    
    <bean id="localeServiceListener"
        class="org.panifex.web.impl.i18n.LocaleServiceListener"
        factory-method="init"
        destroy-method="destroy"/>
    
    <!-- Login -->
    
    <bean id="changePasswordFormRichletBinder"
        class="org.panifex.web.impl.view.login.ChangePasswordFormRichletBinder"/>
    
    <bean id="loginFormRichletBinder"
        class="org.panifex.web.impl.view.login.LoginFormRichletBinder"/>
    
    <!-- Main Window -->
    
    <bean id="mainRichletBinder"
        class="org.panifex.web.impl.view.main.MainRichletBinder"/>
    
    <!-- Settings Content -->
    
    <reference-list interface="org.panifex.module.api.settings.SettingsContent"
            availability="optional">
        <reference-listener ref="settingsContentManager"
            bind-method="bind"
            unbind-method="unbind"/>    
    </reference-list>
    
    <bean id="settingsContentManager"
        class="org.panifex.web.impl.settings.SettingsContentManager"
        factory-method="init"
        destroy-method="destroy"/>
    
    <service ref="settingsContentView">
        <interfaces>
            <value>org.panifex.module.api.content.Content</value>
        </interfaces>
    </service>
    
    <bean id="settingsContentView"
        class="org.panifex.web.impl.view.settings.SettingsContentView"/>
    
    <!-- Web Container Listener -->

    <reference interface="org.ops4j.pax.web.service.WebContainer"
            availability="optional">
        <reference-listener ref="webContainerListener"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference>

    <bean id="webContainerListener"
            class="org.panifex.web.impl.WebContainerListener">
        <property name="bundleContext" ref="blueprintBundleContext"/>
        <property name="securityFilter" ref="securityFilter"/>
        <property name="zkLayoutService" ref="zkLayoutService"/>
    </bean>
    
    <!-- Zk Layout Service -->
    
    <reference interface="org.panifex.web.impl.servlet.ZkLayoutService"
            availability="optional">
        <reference-listener ref="changePasswordFormRichletBinder"
            bind-method="bind"
            unbind-method="unbind"/>
        <reference-listener ref="loginFormRichletBinder"
            bind-method="bind"
            unbind-method="unbind"/>
        <reference-listener ref="mainRichletBinder"
            bind-method="bind"
            unbind-method="unbind"/>
    </reference>
    
    <bean id="zkLayoutService"
        class="org.panifex.web.impl.servlet.ZkLayoutServiceImpl"/>
</blueprint>